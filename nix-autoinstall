#!/bin/sh


set -u
set -o pipefail

readonly CLRLINE='\033[0K'
readonly ESC='\033[0m'
readonly BOLD='\033[1m'
readonly BLUE='\033[34m'
readonly BLUE_UL='\033[4;34m'
readonly GREEN='\033[32m'
readonly GREEN_UL='\033[4;32m'
readonly RED='\033[31m'

# Script to perform installation of Nix on MacOS
#

{ # Prevent execution if this script was only partially downloaded
oops() {
    echo "$0:" "$@" >&2
    exit 1
}

umask 0022

# Perform automated install
tmpDir="$(mktemp -d -t nixautoinstalldir.XXXXXXXXX || \
          oops "Can't create temporary directory for downloading the Nix install script")"

cleanup() {
    rm -rf "$tmpDir"
}
trap cleanup EXIT INT QUIT TERM


function get_gitfolder () {
    [[ ! -n "${gitfolder+1}" ]] || return
    local prompt="${BOLD}${GREEN}Enter name of subfolder within $HOME to clone mymacnix: ${ESC}"
    printf "$prompt"
    while read -r folder </dev/tty; do
        if [ "$folder" != "" ]; then
            if [[ ! -e "$HOME/$folder" ]]; then
                break
            fi
            echo "${RED}$HOME/$folder already exists - please choose another directory${ESC}"
        fi
        printf "$prompt"
    done
    eval "export gitfolder=$HOME/$folder"
}

get_gitfolder

curl -L https://nixos.org/nix/install > "$tmpDir/nixinstall"
yes | sh "$tmpDir/nixinstall"

echo "${BOLD}${GREEN}--> Starting a new sub-shell to clone mymacnix git folder${ESC}"
curl -L https://raw.githubusercontent.com/khsoh/mymacnix/main/clonerepo-autoinstall > "$tmpDir/clonerepo"
zsh -l "$tmpDir/clonerepo"


} # End of wrapping

